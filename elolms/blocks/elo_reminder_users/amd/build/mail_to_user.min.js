define(["jquery","core/ajax","core/str","core/notification","core/modal_factory","core/modal_events","core/templates"],function(e,t,n,r,a,i,o){var s={MAIL_TO_USER_LINK:".mail-to-user",MAIL_TO_USER_ICON:".mail-to-user .icon",BULKACTIONSELECT:"#beruformactionid",BULKUSERCHECKBOXES:"input.beruusercheckbox",BULKUSERNOSCHECKBOXES:"input.beruusercheckbox[value='0']",BULKUSERSELECTEDCHECKBOXES:"input.beruusercheckbox:checked",BULKACTIONFORM:"#beruparticipantsform",CHECKALLONPAGEBUTTON:"#berucheckallonpage",CHECKNONEBUTTON:"#beruchecknone",VIEWHISTORIES:".viewhistories"},c=function(e,t){void 0!==t&&t.remove();l(u("failed"),e),f("failed",e,t)},d=function(e){switch(e){case"send":return 1;case"sending":return 2;case"failed":return 0;case"resend":return 3;default:return 1}},u=function(e){switch(e){case"send":return"sending";case"sending":return"sent";case"failed":return"resend";case"resend":return"sending";default:return"send"}},l=function(t,n){E(t).then(function(r){e(n).attr({"data-action":t,title:r})}).catch(r.exception)},f=function(t,n,a){var i=e(n).find(".icon");E(u(t)).then(function(r){e(i).attr({title:r,"aria-label":r}),i.is("img")?e(i).attr({src:M.util.image_url("t/"+t),alt:r}):(e(i).addClass(h(t)),e(i).removeClass(v(h(t)))),void 0!==a&&a.remove(),n.show()}).catch(function(e){r.exception(e),void 0!==a&&a.remove(),n.show()})},h=function(e){switch(e){case"sending":return"fa-envelope-o";case"sent":return"fa-paper-plane";case"failed":return"fa-repeat";case"resend":default:return"fa-paper-plane"}},v=function(e){return"fa-repeat fa-paper-plane fa-envelope-o".replace(e,"")},E=function(e){return n.get_string("mail_status:"+e,"block_elo_reminder_users")},p=function(e,t){return n.get_string("modal:"+e,"block_elo_reminder_users",t)},m=function(n){var a,i=n.attr("data-action"),o=n.attr("data-userid"),s=n.attr("data-lastaccess"),h=n.attr("data-courseid");"send"!=i&&"resend"!=i||(n.hide(),(a=e("#mail-to-user-sending").clone()).attr("id","elo-sending-"+o).insertAfter(n),function(e,n,a,i,o,s){var h={methodname:"block_elo_reminder_users_mailtouser",args:{value:d(e),userid:n,lastaccess:a,courseid:i}};t.call([h])[0].then(function(t){if(void 0!==(t=JSON.parse(t.elodata)).success){var n=u(e);l(u(n),o),f(n,o,s)}else void 0!==t.error&&(c(o,s),alert(t.error.message))}).catch(function(e){r.exception(e),c(o,s)})}(i,o,s,h,n,a))};return{init:function(){e(s.MAIL_TO_USER_LINK).on("click",function(t){t.preventDefault();var n=e(this),r=n.attr("data-action");"send"!=r&&"resend"!=r||function(t){var n=e("#create-modal"),r=t.attr("data-email");a.create({type:a.types.SAVE_CANCEL,title:p("title",""),body:p("body",r)},n).done(function(e){e.setSaveButtonText(p("confirm","")),e.getRoot().on(i.save,function(n){n.preventDefault(),e.hide(),m(t)}).on(i.hidden,function(){e.destroy()}),e.show()})}(n)}),e(s.VIEWHISTORIES).on("click",function(n){n.preventDefault();var o=e(this),s=o.attr("data-courseid");!function(n,o){if(!n||0==n.length)return!1;var s=e("#create-modal");a.create({type:a.types.CANCEL,title:p("title:viewhistories",""),body:""},s).done(function(e){e.show();var a={methodname:"block_elo_reminder_users_viewhistories",args:{userid:n,courseid:o}};t.call([a])[0].then(function(t){if(void 0!==(t=JSON.parse(t.elodata)).success){var n='<div class="block"><table class="flexible elo_flexible_custom"><thead>';for(var r in t.success.data.columns)n+='<th class="header">'+t.success.data.columns[r]+"</th>";for(var r in n+="</thead><tbody>",t.success.data.listusers){var a=t.success.data.listusers[r],i=new Date(1e3*a.timemodified),o=("0"+i.getDate()).slice(-2)+"/"+("0"+(i.getMonth()+1)).slice(-2)+"/"+i.getFullYear()+" "+("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2);n+="<tr>",n+="<td>"+a.rownum+"</td>",n+="<td>"+a.firstname+" "+a.lastname+"</td>",n+="<td>"+a.coursefullname+"</td>",n+="<td>"+o+"</td>",n+="</tr>"}n+="</tbody></table></div>",e.setBody(n)}else t.error}).catch(function(e){r.exception(e)}),e.getRoot().on(i.hidden,function(){e.destroy()})})}(o.attr("data-userid"),s)}),e(s.CHECKALLONPAGEBUTTON).on("click",function(){e(s.BULKUSERCHECKBOXES).prop("checked",!0)}),e(s.CHECKNONEBUTTON).on("click",function(){e(s.BULKUSERCHECKBOXES).prop("checked",!1)}),e(s.BULKACTIONSELECT).on("change",function(t){var n=e(t.target).val();if(-1!==n.indexOf("#")){t.preventDefault();var r=[];e(s.BULKUSERSELECTEDCHECKBOXES).each(function(t,n){var a=e(n).attr("name").replace("user","");r.push(a)}),function(t){if(!t||0==t.length)return!1;var n=e("#create-modal"),r=[],o=[];$eleSend=e(s.MAIL_TO_USER_LINK);for(var c=0;c<$eleSend.length;c++){var d=e($eleSend[c]),u=d.attr("data-action"),l=d.attr("data-userid");!t.includes(l)||"send"!=u&&"resend"!=u||(r.push(d.attr("data-email")),o.push(d))}a.create({type:a.types.SAVE_CANCEL,title:p("title",""),body:p("body:multiple","<br>"+r.join("; <br>"))},n).done(function(e){e.setSaveButtonText(p("confirm","")),e.getRoot().on(i.save,function(t){t.preventDefault(),e.hide();for(var n=0;n<o.length;n++)m(o[n])}).on(i.hidden,function(){e.destroy()}),e.show()})}(r),e(s.BULKACTIONSELECT+' option[value=""]').prop("selected","selected")}else""!==n&&e(s.BULKACTIONFORM).submit()}.bind(this))}}});